<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche de Personnage - The Witcher</title>
    <link href="../styles/styles.css" rel="stylesheet">
    <script src="../datas/constantes.js"></script>
    <script src="../scripts/utils.js"></script>
    <script src="../datas/cache.js"></script>
    <script src="../scripts/saveSystem.js"></script>
    <script src="../scripts/main.js" defer></script>
    <link rel="icon" type="image/x-icon" href="../pictures/logo.png">
</head>
<style>
    h2{
        width: 10rem;
    }

    .titleDiv{
        display: flex;
        justify-content: flex-start;
        align-items: center;
    }
    table{
        width: 100vw;
        text-align: center;
    }
 
    
</style>
<body>
    <div class="mainTitle">
        <img src="../pictures/logo.png" style="height: 10rem; width: 10rem;">
        <h1> The Witcher</h1>
    </div>
    <nav>
        <button class="fantasy-btn-sm fantasy-bone-n-coper" onclick="window.location.href='../character.html'">Fiche</button>
        <button class="fantasy-btn-sm fantasy-bone-n-coper" onclick="window.location.href='./grimoire.html'">Grimoire</button>
        <button class="fantasy-btn-sm fantasy-bone-n-coper" onclick="window.location.href='./help.html'">Aide et Rappels</button>
        <button class="fantasy-btn-sm fantasy-bone-n-coper" onclick="window.location.href='./background.html'">Background et Notes </button>
        <button class="fantasy-btn-sm fantasy-bone-n-coper" onclick="window.location.href='./saves.html'">Choix du Personnage</button>
        <button class="fantasy-btn-sm fantasy-bone-n-coper" onclick="saveCharacter()">Sauvegarder personnage</button>
    </nav>
    <div class="infos-container container">
        <h1>Inventaire et Composants</h1>
        <section class="infos-container"></section>
            <div class="titleDiv">
                <h2>Armes</h2> 
                <button class="fantasy-btn-sm" onclick="addRow('weapon')">Ajouter</button>
            </div>
            <table id="weapons-table">
                <tr>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Précision</th>
                    <th>Poids</th>
                    <th>Dégâts</th>
                    <th>Fia.</th>
                    <th>Mains</th>
                    <th>Portée</th>
                    <th>Effet</th>
                    <th>Dissumlation</th>
                    <th>Amélioration</th>
                    <th>Equipé Principale</th>
                    <th>Equipé Secondaire</th>
                    <th>Actions</th>
                </tr>

            </table>
        </section>
        <section class="infos-container"></section>
            <div class="titleDiv">
                <h2>Armures</h2>
                <button class="fantasy-btn-sm" onclick="addRow('armor')">Ajouter</button>
            </div>
            <table id="armors-table">
                <tr>
                    <th>Nom</th>
                    <th>Localisation</th>
                    <th>PA</th>
                    <th>Poids</th>
                    <th>Dégâts</th>
                    <th>Effet</th>
                    <th>Equipé Principale</th>
                    <th>Equipé Secondaire</th>
                    <th>Actions</th>
                </tr>
            </table>
        </section>
        
        <section class="infos-container">
            <div class="titleDiv">
                <h2>Divers</h2>
                <button class="fantasy-btn-sm" onclick="addRow('miscellaneous')">Ajouter</button>
            </div>
            <table id="miscellaneous-table">
                <tr>
                    <th>Nom</th>
                    <th>Quantité</th>
                    <th>Poids Unité</th>
                    <th>Poids total</th>
                    <th>Notes</th>
                    <th>Couts</th>
                    <th>Actions</th>
                </tr>
            </table>
        </section>
        <section class="infos-container">
            <div class="titleDiv">
                <h2>Composants</h2>
                <button class="fantasy-btn-sm" onclick="addRow('component')">Ajouter</button>
            </div>
            <table id="components-table">
                <tr>
                    <th>Nom</th>
                    <th>Quantité</th>
                    <th>Poids Unité</th>
                    <th>Poids total</th>
                    <th>Couts</th>
                    <th>Substance</th>
                    <th>Actions</th>
                </tr>
            </table>
        </section>
    </div>

</body>
<script type="text/javascript">
    let weightInputList = ""; 
    let weightTt = 0; // total of character weigth (centralised on this page)
    let cache = loadCache();
    const weaponsRowBase = `
            <td><input type="text" size="10"></td> 
            <td><input type="text" size="10"></td>
            <td><input type="number" size="2"></td>
            <td><input type="number" size="2" class="weightInput"></td>
            <td><input type="text" size="10"></td>
            <td><input type="number" size="2"></td>
            <td><input type="number" size="2"></td>
            <td><input type="text" size="10"></td>
            <td><textarea rows="1" cols="auto"></textarea></td>
            <td><input type="text" size="10"></td>
            <td><input type="number" size="2"></td>
            <td><input type="checkbox" id="mainEquipedWeapon"></td>
            <td><input type="checkbox" id="secEquipedWeapon"></td>
            
        `;

        const armorsRowBase = `
            <td><input type="text" size="10"></td>
            <td><input type="text" size="10"></td>
            <td><input type="number" size="2"></td>
            <td><input type="number" size="2" class="weightInput"></td>
            <td><input type="number" size="2"></td>
            <td><textarea rows="1" cols="auto"></textarea></td>
            <td><input type="checkbox" id="mainEquipedArmor"></td>
            <td><input type="checkbox" id="secEquipedArmor"></td>
        `;
        const miscellaneousRowBase = `
            <td><input type="text" size="10"></td>
            <td><input type="number" size="2" value="1"></td>
            <td><input type="number" size="2"></td>
            <td><input type="number" size="2" class="weightInput" readonly></td>
            <td><textarea rows="1" cols="auto"></textarea></td>
            <td><input type="number" size="2"></td>
            
        `;
        const componentRowBase = `
            <td><input type="text" size="10"></td>
            <td><input type="number" size="2" value="1"></td>
            <td><input type="number" size="2"></td>
            <td><input type="number" size="2" class="weightInput" readonly></td>
            <td><input type="number" size="2"></td>
            <td><input type="text" size="10"></td>
            
        `;
    completeTableWithCache(cache.character.inventory)
    function completeTableWithCache(datas) {
        let table = "";
        for(const key in datas){
            if (datas[key].length > 0){
                datas[key].forEach(element => {
                    let row = document.createElement('tr');
                    let baseKeys = null
                    switch(key){
                        case 'weapons':
                            table = document.getElementById('weapons-table')
                            row.innerHTML = weaponsRowBase;
                            baseKeys = keysWeaponDTO;
                            table.appendChild(row)
                            break;
                    
                        case 'armors':
                            table = document.getElementById('armors-table')
                            row.innerHTML = armorsRowBase;
                            baseKeys = keysArmorDTO;
                            table.appendChild(row)
                            break;

                        case 'miscellaneous':
                            table = document.getElementById('miscellaneous-table')
                            row.innerHTML = miscellaneousRowBase;
                            baseKeys = keysMiscDTO;
                            table.appendChild(row)
                            break;

                        case 'components':
                            table = document.getElementById('components-table')
                            row.innerHTML = componentRowBase;
                            baseKeys = keysComponentDTO;
                            table.appendChild(row)
                            break;
                    }
                    for(i=0; i < row.children.length; i++){
                        row.children[i].firstChild.value = element[baseKeys[i]];
                        row.dispatchEvent(new Event('input'));
                    }
                    let cell = document.createElement("td");
                    let buttonDel = document.createElement("button");
                    cell.appendChild(buttonDel);
                    row.appendChild(cell);
                    buttonDel.innerText = "supprimer";
                    buttonDel.className = "fantasy-btn-sm";
                    // manage delete row when button "supprimer" cliked
                    buttonDel.addEventListener("click", e=> {
                        weightTt -= parseFloat(row.children[3].firstChild.value); // // subtracting the total weight of the item removed 
                        cache.character.currentWeight = weightTt;
                        // delete cache element based on "type" parameter
                        switch(key){
                            case "weapons":
                                cache.character.inventory.weapons.splice(row.rowIndex -1, 1); // delete the target row (index retrieve with row.rowIndex property)
                                break;
                            case "armors":
                                cache.character.inventory.armors.splice(row.rowIndex -1, 1);
                                break;

                            case "miscellaneous":
                                cache.character.inventory.miscellaneous.splice(row.rowIndex -1, 1);
                                break;

                            case "components":
                                cache.character.inventory.components.splice(row.rowIndex -1, 1);
                                break;
                        }
                        localStorage.setItem(keys.storage, JSON.stringify(cache))
                        table.deleteRow(row.rowIndex);
                    })
                });
            }  
            
        }
    }
    function addRow(type) {
        

        let table ="";
        let row = document.createElement("tr");
        // select base html depending on type parameter
        switch(type){ 
            case "weapon":
                table = document.getElementById("weapons-table");
                row.innerHTML = weaponsRowBase;
                table.appendChild(row);
                break;
            case "armor":
                table = document.getElementById("armors-table");
                row.innerHTML = armorsRowBase;
                table.appendChild(row);
                break;

            case "miscellaneous":
                table = document.getElementById("miscellaneous-table");
                row.innerHTML = miscellaneousRowBase;
                table.appendChild(row);
                break;

            case "component":
                table = document.getElementById("components-table");
                row.innerHTML = componentRowBase;
                table.appendChild(row);
                break;
        }
        // create button for each new row
        let cell = document.createElement("td");
        let buttonDel = document.createElement("button");
        cell.appendChild(buttonDel);
        row.appendChild(cell);
        buttonDel.innerText = "supprimer";
        buttonDel.className = "fantasy-btn-sm";
        // manage delete row when button "supprimer" cliked
        buttonDel.addEventListener("click", e=> {
            weightTt -= parseFloat(row.children[3].firstChild.value); // // subtracting the total weight of the item removed 
            cache.character.currentWeight = weightTt;
            // delete cache element based on "type" parameter
            switch(type){
                case "weapon":
                    cache.character.inventory.weapons.splice(row.rowIndex -1, 1); // delete the target row (index retrieve with row.rowIndex property)
                    break;
                case "armor":
                    cache.character.inventory.armors.splice(row.rowIndex -1, 1);
                    break;

                case "miscellaneous":
                    cache.character.inventory.miscellaneous.splice(row.rowIndex -1, 1);
                    break;

                case "component":
                    cache.character.inventory.components.splice(row.rowIndex -1, 1);
                    break;
            }
            localStorage.setItem(keys.storage, JSON.stringify(cache))
            table.deleteRow(row.rowIndex);
        })
        for(i = 0; i < row.children.length; i++){
            let timeout = null
            let index = i; // fix i for each event
            row.children[i].firstChild.addEventListener('input', e => {

                switch(type){
                    case "weapon":
                        if(index === 3){ // auto calcul of total weight
                            clearTimeout(timeout);
                        // Make a new timeout set to go off in 1000ms (1 second)
                            timeout = setTimeout(function () {
                                miscDTO[3] = e.target.value;
                                weightTt += parseFloat(e.target.value);// add to total the target value
                                cache.character.currentWeight = weightTt;
                                localStorage.setItem(keys.storage, JSON.stringify(cache))
                            }, 1000);
                            
                        }
                        weaponDTO[keysWeaponDTO[index]] = e.target.value;
                        cache.character.inventory.weapons[row.rowIndex -1] = weaponDTO ;
                        localStorage.setItem(keys.storage, JSON.stringify(cache))
                        break;
                    case "armor":
                    if(index === 3){ // auto calcul of total weight
                        clearTimeout(timeout);
                        // Make a new timeout set to go off in 1000ms (1 second)
                            timeout = setTimeout(function () {
                                miscDTO[3] = e.target.value;
                                weightTt += parseFloat(e.target.value);// add to total the target value
                                cache.character.currentWeight = weightTt;
                                localStorage.setItem(keys.storage, JSON.stringify(cache))
                            }, 1000);
                            
                        }
                        armorDTO[keysArmorDTO[index]] = e.target.value;
                        cache.character.inventory.armors[row.rowIndex - 1] = armorDTO;
                        localStorage.setItem(keys.storage, JSON.stringify(cache))
                        break;

                    case "miscellaneous":
                        if(index === 1 || index === 2){ // auto calcul of total weight
                            clearTimeout(timeout);
                        // Make a new timeout set to go off in 1000ms (1 second)
                            timeout = setTimeout(function () {
                                row.children[3].firstChild.value = parseFloat(row.children[1].firstChild.value) * parseFloat(row.children[2].firstChild.value);
                                miscDTO[keysMiscDTO[3]] = row.children[3].firstChild.value
                                weightTt += parseFloat(row.children[3].firstChild.value);// add to total the target value
                                cache.character.currentWeight = weightTt;
                                localStorage.setItem(keys.storage, JSON.stringify(cache))
                            }, 1000);
                            
                        }
                        miscDTO[keysMiscDTO[index]] = e.target.value;
                        cache.character.inventory.miscellaneous[row.rowIndex - 1] = miscDTO;
                        localStorage.setItem(keys.storage, JSON.stringify(cache))
                        break;

                    case "component":
                    if(index === 1 || index === 2){
                            clearTimeout(timeout);
                        // Make a new timeout set to go off in 1000ms (1 second)
                            timeout = setTimeout(function () {
                                row.children[3].firstChild.value = parseFloat(row.children[1].firstChild.value) * parseFloat(row.children[2].firstChild.value);
                                componentDTO[keysComponentDTO[3]] = row.children[3].firstChild.value
                                weightTt += parseFloat(row.children[3].firstChild.value);// add to total the target value
                                cache.character.currentWeight = weightTt;
                                localStorage.setItem(keys.storage, JSON.stringify(cache))
                            }, 1000);
                            
                        }
                        componentDTO[keysComponentDTO[index]] = e.target.value;
                        cache.character.inventory.components[row.rowIndex - 1] = componentDTO;
                        localStorage.setItem(keys.storage, JSON.stringify(cache))
                        break;
                }
                
            })
        }
        weightInputList = document.getElementsByClassName("weightInput"); // list of all input weigthInput class (refresh of each deletion/creation)
        // add all weight total
        for(let w of weightInputList){ 
            let timeout = null;
            w.addEventListener('input', e => {
                clearTimeout(timeout);
                // Make a new timeout set to go off in 1000ms (1 second)
                timeout = setTimeout(function () {
                    weightTt += parseFloat(e.target.value);// add to total the target value
                    cache.character.currentWeight = weightTt;
                    localStorage.setItem(keys.storage, JSON.stringify(cache))
                }, 1000);
                        
            })
        }
    }
</script>
</html>